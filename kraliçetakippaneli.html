// kraliçetakippaneli.js

let uyeler = [];

function uyeEkle() {
  const isim = document.getElementById("isim").value;
  const hedefBaslangic = new Date(document.getElementById("hedefBaslangic").value);
  const hedefBitis = new Date(document.getElementById("hedefBitis").value);
  const ciroBaslangic = parseFloat(document.getElementById("ciroBaslangic").value) || 0;
  const ciroBitis = parseFloat(document.getElementById("ciroBitis").value) || 0;
  const puanBaslangic = parseFloat(document.getElementById("puanBaslangic").value) || 0;
  const puanBitis = parseFloat(document.getElementById("puanBitis").value) || 0;
  const yeniKayit = parseInt(document.getElementById("yeniKayit").value) || 0;
  const unvan = document.getElementById("unvan").value;
  const tesvik = document.getElementById("tesvik").value;
  const satislar = document.getElementById("satislar").value;
  const rozet = document.getElementById("rozet").value;
  const aciklama = document.getElementById("aciklama").value;

  const ciroArtisi = ciroBitis - ciroBaslangic;
  const puanArtisi = puanBitis - puanBaslangic;

  const uye = {
    isim,
    hedefTarihi: `${hedefBaslangic.toLocaleDateString()} - ${hedefBitis.toLocaleDateString()}`,
    ciroArtisi,
    puanArtisi,
    yeniKayit,
    unvan,
    tesvik,
    satislar,
    rozet,
    aciklama
  };

  uyeler.push(uye);
  tabloGuncelle();
  grafikGuncelle();
  enBasariliGuncelle();
  temizle();
}

function tabloGuncelle() {
  const tablo = document.getElementById("uyeTablosu");
  tablo.innerHTML = "";
  uyeler.forEach(uye => {
    const satir = `<tr>
      <td>${uye.isim}</td>
      <td>${uye.hedefTarihi}</td>
      <td>${uye.ciroArtisi}</td>
      <td>${uye.puanArtisi}</td>
      <td>${uye.yeniKayit}</td>
      <td>${uye.unvan}</td>
      <td>${uye.tesvik}</td>
      <td>${uye.satislar}</td>
      <td>${uye.rozet}</td>
      <td>${uye.aciklama}</td>
    </tr>`;
    tablo.innerHTML += satir;
  });
}

function enBasariliGuncelle() {
  const liste = document.getElementById("enBasariliListe");
  liste.innerHTML = "";
  const sirali = [...uyeler].sort((a, b) => b.ciroArtisi - a.ciroArtisi).slice(0, 10);
  sirali.forEach(u => {
    liste.innerHTML += `<li>${u.isim} – ${u.ciroArtisi} Ciro Artışı</li>`;
  });
}

function grafikGuncelle() {
  const ctx = document.getElementById('grafikChart').getContext('2d');
  const labels = uyeler.map(u => u.isim);
  const ciroVeri = uyeler.map(u => u.ciroArtisi);
  const puanVeri = uyeler.map(u => u.puanArtisi);
  if (window.grafik) window.grafik.destroy();
  window.grafik = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        { label: 'Ciro Artışı', data: ciroVeri },
        { label: 'Puan Artışı', data: puanVeri }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'top' } }
    }
  });
}

function filtrele() {
  const arama = document.getElementById("searchBox").value.toLowerCase();
  const filtrelenmis = uyeler.filter(u =>
    u.isim.toLowerCase().includes(arama) ||
    u.unvan.toLowerCase().includes(arama) ||
    u.satislar.toLowerCase().includes(arama)
  );
  const tablo = document.getElementById("uyeTablosu");
  tablo.innerHTML = "";
  filtrelenmis.forEach(uye => {
    const satir = `<tr>
      <td>${uye.isim}</td>
      <td>${uye.hedefTarihi}</td>
      <td>${uye.ciroArtisi}</td>
      <td>${uye.puanArtisi}</td>
      <td>${uye.yeniKayit}</td>
      <td>${uye.unvan}</td>
      <td>${uye.tesvik}</td>
      <td>${uye.satislar}</td>
      <td>${uye.rozet}</td>
      <td>${uye.aciklama}</td>
    </tr>`;
    tablo.innerHTML += satir;
  });
}

function disAktarPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("Kraliçe Takip Paneli Raporu", 10, 10);
  let y = 20;
  uyeler.forEach((u, i) => {
    doc.text(`${i + 1}. ${u.isim} | Ciro: ${u.ciroArtisi} | Puan: ${u.puanArtisi} | Ünv.: ${u.unvan}`, 10, y);
    y += 10;
  });
  doc.save("kraliçe_panel_raporu.pdf");
}

function disAktarExcel() {
  const ws = XLSX.utils.json_to_sheet(uyeler);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Panel Verileri");
  XLSX.writeFile(wb, "kraliçe_panel_verileri.xlsx");
}

function temizle() {
  document.querySelectorAll("input").forEach(input => input.value = "");
}
